<!doctype html><html lang=en-US prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="David Calhoun"><title>Ditching Disqus (Migrating Away Since It Has Become a Monster) - David Calhoun's blog</title><style>html body{font-family:roboto,sans-serif}</style><link rel=stylesheet href=https://www.davidbcalhoun.com/css/main.min.ed189e9bcb0c5d3b97ea9c4bca48f5b8e6bc300bbf923dc272441485706475b6.css><link rel=preconnect href=https://comments.davidbcalhoun.com><link rel=preconnect href=https://ssl.gstatic.com><link rel=preconnect href=https://cdnjs.cloudflare.com><link rel=preconnect href=https://accounts.google.com><link rel=preconnect href=https://apis.google.com><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><link rel=preload href=/commento.css as=style><meta name=generator content="Hugo 0.147.1"><style>@font-face{font-family:roboto;font-style:normal;font-weight:400;font-display:swap;src:local('Roboto'),local('Roboto-Regular'),url(/wp-content/fonts/roboto-v20-latin-regular.woff2)format('woff2'),url(/wp-content/fonts/roboto-v20-latin-regular.woff)format('woff')}</style><meta name=description content="Detailing how to fully export Disqus comments and migrate to Commento."><link rel=canonical href=https://www.davidbcalhoun.com/2020/ditching-disqus-migrating-away-since-it-has-become-a-monster/><link href=/index.xml rel=alternate type=application/rss+xml title="David Calhoun's blog"><link href=/index.xml rel=feed type=application/rss+xml title="David Calhoun's blog"><link href=/index.xml rel=self type=application/rss+xml title="David Calhoun's blog"><meta name=format-detection content="telephone=no"><meta itemprop=name content="Ditching Disqus (Migrating Away Since It Has Become a Monster)"><meta itemprop=headline content="Ditching Disqus (Migrating Away Since It Has Become a Monster)"><meta itemprop=description content="Detailing how to fully export Disqus comments and migrate to Commento."><meta itemprop=image content="https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-network-requests.png"><meta itemprop=author content="David Calhoun"><link rel=me href=https://www.themaingate.net/ type=text/html><link rel=me href=mailto:david.b.calhoun+dc@gmail.com><link rel=me href=https://www.linkedin.com/in/davidcalhoun/ type=text/html><link rel=me href=https://github.com/davidcalhoun type=text/html><link rel=me href=https://twitter.com/franksvalli type=text/html><link rel=archives href=https://example.com/archives/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:url" content="https://www.davidbcalhoun.com/2020/ditching-disqus-migrating-away-since-it-has-become-a-monster/"><meta property="og:title" content="Ditching Disqus (Migrating Away Since It Has Become a Monster)"><meta property="og:image" content="https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-network-requests.png"><meta property="og:image:alt" content="Disqus unleashed: making almost 100 HTTP requests to its own servers and random ad servers."><meta property="og:description" content="Detailing how to fully export Disqus comments and migrate to Commento."><meta property="og:site_name" content="David Calhoun's Blog"><meta property="og:updated_time" content=2020-01-10T10:28:03-0500><meta property="article:published_time" content=2020-01-10T10:28:03-0500><meta property="article:modified_time" content=2020-01-10T10:28:03-0500><meta property="article:section" content="disqus"><meta property="article:author" content="https://www.davidbcalhoun.com"><meta property="article:image" content="https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-network-requests.png"><meta property="article:tag" content="disqus"><meta property="article:tag" content="commento"><meta property="article:tag" content="comments"><meta property="article:tag" content="blogging"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Ditching Disqus (Migrating Away Since It Has Become a Monster)"><meta name=twitter:url content="https://www.davidbcalhoun.com/2020/ditching-disqus-migrating-away-since-it-has-become-a-monster/"><meta name=twitter:site content="@franksvalli"><meta name=twitter:creator content="@franksvalli"><meta name=twitter:domain content="davidbcalhoun.com"><meta name=twitter:description content="Detailing how to fully export Disqus comments and migrate to Commento."><meta name=twitter:image content="https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-network-requests.png"><meta name=twitter:image:alt content="Disqus unleashed: making almost 100 HTTP requests to its own servers and random ad servers."><link rel="Shortcut Icon" type=image/ico href=https://www.davidbcalhoun.com/favicon.ico></head><body><nav class=navbar><div class=navbar-header><a class=navbar-brand href=https://www.davidbcalhoun.com/>David Calhoun's blog</a></div><ul class=navbar-links><li class=navbar-icon><a aria-label="Send an email" title="Send an email" href=mailto:david.b.calhoun+dc@gmail.com><svg aria-label="email" role="img" width="1792" height="1792" viewBox="0 0 1792 1792"><path d="M1664 1504V736q-32 36-69 66-268 206-426 338-51 43-83 67t-86.5 48.5T897 1280h-2q-48 0-102.5-24.5T706 1207t-83-67q-158-132-426-338-37-30-69-66v768q0 13 9.5 22.5t22.5 9.5h1472q13 0 22.5-9.5t9.5-22.5zm0-1051v-24.5l-.5-13-3-12.5-5.5-9-9-7.5-14-2.5H160q-13 0-22.5 9.5T128 416q0 168 147 284 193 152 401 317 6 5 35 29.5t46 37.5 44.5 31.5T852 1143t43 9h2q20 0 43-9t50.5-27.5 44.5-31.5 46-37.5 35-29.5q208-165 401-317 54-43 100.5-115.5T1664 453zm128-37v1088q0 66-47 113t-113 47H160q-66 0-113-47T0 1504V416q0-66 47-113t113-47h1472q66 0 113 47t47 113z"/></svg></i></a></li><li class=navbar-icon><a aria-label="Home Page" title="Home Page" href=https://www.themaingate.net/><svg aria-label="home site" role="img" viewBox="0 0 576 512"><path d="M280.37 148.26 96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V3e2L295.67 148.26a12.19 12.19.0 00-15.3.0zM571.6 251.47 488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19.0 0115.3.0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg></i></a></li><li class=navbar-icon><a aria-label=Twitter title=Twitter href=https://twitter.com/franksvalli/><svg aria-label="twitter" role="img" width="1792" height="1792" viewBox="0 0 1792 1792"><path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5T1369.5 1125 1185 1335.5t-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5T285 1033q33 5 61 5 43 0 85-11-112-23-185.5-111.5T172 710v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5T884 653q-8-38-8-74 0-134 94.5-228.5T1199 256q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"/></svg></i></a></li><li class=navbar-icon><a aria-label=Github title=Github href=https://github.com/davidcalhoun/><svg aria-label="github" role="img" width="1792" height="1792" viewBox="0 0 1792 1792"><path d="M896 128q209 0 385.5 103T1561 510.5 1664 896q0 251-146.5 451.5T1139 1625q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105T1386 856q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27T578 459.5 493 446q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5T484 1274q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5T128 896q0-209 103-385.5T510.5 231 896 128zM419 1231q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg></i></a></li><li class=navbar-icon><a aria-label=LinkedIn title=LinkedIn href=https://www.linkedin.com/in/davidcalhoun/><svg aria-label="linkedin" role="img" width="1792" height="1792" viewBox="0 0 1792 1792"><path d="M477 625v991H147V625h330zm21-306q1 73-50.5 122T312 490h-2q-82 0-132-49t-50-122q0-74 51.5-122.5T314 148t133 48.5T498 319zm1166 729v568h-329v-530q0-105-40.5-164.5T1168 862q-63 0-105.5 34.5T999 982q-11 30-11 81v553H659q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5T1285 602q171 0 275 113.5t104 332.5z"/></svg></i></a></li></ul></nav><main role=main itemscope itemtype=https://schema.org/BlogPosting><meta itemprop=mainEntityOfPage content="https://www.davidbcalhoun.com/2020/ditching-disqus-migrating-away-since-it-has-become-a-monster/"><meta itemprop=inLanguage content="en-US"><span itemscope itemprop=author itemtype=https://schema.org/Person><meta itemprop=name content="David Calhoun"><meta itemprop=url content="https://www.themaingate.net"></span><span itemscope itemprop=publisher itemtype=https://schema.org/Organization><meta itemprop=name content="David Calhoun"><meta itemprop=url content="https://www.themaingate.net"><span itemprop=logo itemscope itemtype=https://schema.org/ImageObject><meta itemprop=url content="https://www.themaingate.net/david-calhoun-logo.png"><meta itemprop=width content="459"><meta itemprop=height content="459"></span></span><meta itemprop=image content="https://www.themaingate.net/david-calhoun-logo.png"><meta itemprop=datePublished content=2020-01-10T10:28:03-0500/><meta itemprop=dateModified content=2020-01-10T10:28:03-0500/><article class=item><h1 itemprop=headline class="meta title"><a href=https://www.davidbcalhoun.com/2020/ditching-disqus-migrating-away-since-it-has-become-a-monster/ itemprop=url>Ditching Disqus (Migrating Away Since It Has Become a Monster)</a></h1><time class="meta date" datetime="2020-01-10 10:28:03 -0500 -0500">January 10, 2020</time><aside class="meta tags"><span>Tags: </span><a href=https://www.davidbcalhoun.com/tags/disqus><span class=item-tag>disqus</span></a>
<a href=https://www.davidbcalhoun.com/tags/commento><span class=item-tag>commento</span></a>
<a href=https://www.davidbcalhoun.com/tags/comments><span class=item-tag>comments</span></a>
<a href=https://www.davidbcalhoun.com/tags/blogging><span class=item-tag>blogging</span></a></aside></article><div class=text-justify><p>The time has finally come for me to ditch Disqus for comments. I&rsquo;ll let this gif do the talking:</p><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject class=center><meta itemprop=width content="700"><meta itemprop=height content="474"><meta itemprop=url content="https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-amount-of-requests.gif"><a href=https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-amount-of-requests.gif><img itemprop=contentUrl src=https://www.davidbcalhoun.com/wp-content/uploads/2020/disqus-crazy-amount-of-requests.gif title="Disqus unleashed: making almost 100 HTTP requests to its own servers and random ad servers."></a><figcaption itemprop=caption>Disqus unleashed: making almost 100 HTTP requests to its own servers and random ad servers.</figcaption></figure><h2 id=the-downside-of-a-free-service>The downside of a <em>free</em> service</h2><p>As the addage goes: if you are not paying for the product, <em>you</em> are the product. And the ad companies are the customers, vying for the ability to track you and your interests as you move around the web.</p><p>Yet for a free product that&rsquo;s really easy to setup, Disqus was not too bad of a choice back in the day when first migrating to a static site. It was a really easy way to get up and running and requires really minimal configuration. It&rsquo;s a huge timesaver for folks who are focused more on migrating and hosting their content, when the focus on comments is almost an afterthought.</p><p>Back in the day when I first installed Disqus, I really don&rsquo;t think it was as abusive with its HTTP requests. I think I would have noticed it loading almost 100 additional HTTP requests, but then again I may have just overlooked it or only tested with my browser with its adblocking features. I think Disqus, like all things tend to do, has likely just grown larger and more out of control with time.</p><p>It&rsquo;s a bit shocking to snoop around and see all the HTTP requests being made today: a ton of heavy payloads for content from Disqus servers, in addition to ad servers, Facebook (!?), and YouTube. After watching the network panel flood with requests (as you can see in the Gif above) I decided it was time to ditch Disqus and look for alternatives.</p><h2 id=migrating-from-disqus-to-commento>Migrating from Disqus to Commento</h2><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject class=center><meta itemprop=width content="700"><meta itemprop=height content="474"><meta itemprop=url content="https://www.davidbcalhoun.com/wp-content/uploads/2020/commento-website.png"><a href=https://www.commento.io/><img itemprop=contentUrl src=https://www.davidbcalhoun.com/wp-content/uploads/2020/commento-website.png title="Commento's website, promoting performance and privacy above all else.  Sounds good to me!"></a><figcaption itemprop=caption>Commento's website, promoting performance and privacy above all else. Sounds good to me!</figcaption></figure><p>There&rsquo;s a few options out there, but <a href=https://www.commento.io/>Commento</a> stood out. It is by no means perfect, but it&rsquo;s decent enough, and the setup is quite easy for folks willing to pay the $5/month fee. For folks who are cheap and/or not currently able to afford that monthly fee (that&rsquo;s yours truly on both counts), Commento is particularly attractive because is an open-source project that has a free self-hosting option. That&rsquo;s the path I started to go down.</p><h2 id=the-disadvantages-of-using-commento-in-general>The disadvantages of using Commento (in general)</h2><p>Fair warning, Commento has a few rough edges, but it&rsquo;s in active development, so I expect some of the following criticisms to become invalid with time, so do your own research!</p><p>Here&rsquo;s a list of some disadvantages:</p><ul><li><p>Testing locally requires modifying the clientside code in <code>commento.js</code>, as <a href=https://remysharp.com/2019/06/11/ejecting-disqus>Remy Sharp</a> found.</p></li><li><p>Disqus will not export user avatars, links to user websites, Disqus profile urls, or post votes. If you are self-hosting and have access to your local Commento&rsquo;s database, there is a workaround which I&rsquo;ve explained below with some helper code.</p></li><li><p>If your Disqus export doesn&rsquo;t contain trailing slashes and your website does, there will be a mismatch and the page won&rsquo;t load any comments, and it&rsquo;s won&rsquo;t be obvious what&rsquo;s going wrong. I solved this by tweaking <code>commento.js</code> to remove trailing slashes.</p></li><li><p>The comment moderation panel lives on each individual page on your own website. There&rsquo;s no way to see an overview of all comments (the Commento settings page in general is a bit sparse)</p></li><li><p>There&rsquo;s a weird issue with spaces getting eaten up when trying to edit comments.</p></li><li><p>Relative time formatting is a little funky. Commento displays &ldquo;24 months ago&rdquo; instead of a more natural &ldquo;2 years ago&rdquo;. This is <a href=https://gitlab.com/commento/commento/issues/258>intended</a>, but it would be nice to make this configurable. As of now, this is another thing you can simply hack around in <code>commento.js</code></p></li></ul><h3 id=disadvantages-when-self-hosting-commento>Disadvantages when self-hosting Commento</h3><p>This deserves its own section, as many folks will not be going down the self-hosting road.</p><ul><li><p>No built-in support for SSL. This is a big downside, as it requires extra time fiddling around setting up a proxy. This <a href=https://www.freecodecamp.org/news/how-to-setup-worry-free-blog-comments-in-20-simple-steps/>setup guide</a> details that process using Docker containers.</p></li><li><p>Extra overhead of setting up and maintaining a server, database, HTTPS proxy, SSL cert generation/renewal, mail server (for email confirmations), and Oath keys if you want to support users loggin in through Twitter, Google, or Gitlab.</p></li></ul><h2 id=migrating-disqus-avatars-links-and-votes>Migrating Disqus avatars, links, and votes</h2><p>When you <a href=http://disqus.com/admin/discussions/export/>export your comments from Disqus</a>, you receive an email link to a zipped up XML of comments. Commento uses this file to import all your old comments. However there is unfortunately missing information which would be unfortunate to lose.</p><p>For instance, my blog doesn&rsquo;t get a lot of comments in general, but I have a few popular entries such as my aging post about <a href=https://www.davidbcalhoun.com/2014/what-is-amd-commonjs-and-umd/>UMD and older JavaScript modules</a> (which now needs to be updated with ES Modules!), which has a few avatars, links to user sites, and post votes. The top post has over 70 upvotes, so it would be a pity to lose that information.</p><p>Luckily there is a way to get this information, albeit somewhat hacky (but hey, it works):</p><ol><li>Login to <a href=https://disqus.com>Disqus</a>, then click on the site you want to export.</li><li>Open your <code>Network</code> tab in your web dev tools window.</li><li>Click on <code>Moderate comments</code> in the navigation on the left.</li><li>Click on the <code>Approved</code> tab on top.</li><li>Search for <code>list</code> in your Network tab and copy the URL. It will look something like this: <code>https://disqus.com/api/3.0/posts/list?attach=postModHtml&amp;attach=postAuthorRep&amp;limit=25&amp;include=approved&amp;order=desc&amp;related=thread&amp;related=forum&amp;forum=[FORUM_ID_REMOVED]&amp;start=2007-01-01T05%3A00%3A00.000Z&amp;end=2020-01-11T04%3A59%3A59.999Z&amp;api_key=[KEY_REMOVED]&_=1578681496399</code></li><li>In your copied URL, change <code>limit=25</code> to <code>limit=100</code> (100 is the maximum supported by the API). This is your new &ldquo;base URL&rdquo;.</li><li>Request the base URL in your browser or a script.</li><li>To request the next page of comments, inspect the current JSON and copy the contents of <code>cursor.next</code>. Append this to the base url with <code>&amp;cursor=[STRING_YOU_COPIED_FROM_ABOVE]</code>. Append this to the base URL to get the next page. Continue this process for each page until <code>cursor.next</code> is <code>null</code>. Now you&rsquo;ve fetched all the comment pages!</li></ol><h3 id=sample-nodejs-disqus-fetch-script>Sample Node.js Disqus fetch script</h3><p>Below is the Node.js I made to fetch each page of Disqus comments (what I described above) and then convert the relevant bits of info into SQL statements. This worked for me but it&rsquo;s not perfect and a bit hacky. Feel free to tweak it!</p><p>I may eventually move this to Github, but it&rsquo;s here for now. To initialize:</p><ol><li><code>mkdir disqus-migrate && cd disqus-migrate</code></li><li><code>npm init</code> (just accept all the default suggestions)</li><li><code>npm i --save node-fetch</code></li><li><code>touch index.js</code></li><li>Paste the following code into <code>index.js</code> (<strong>make sure to update the URL passed into <code>init()</code> with the &ldquo;Base URL&rdquo; from above</strong>):</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fetch</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node-fetch&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>escapeQuotes</span>(<span style=color:#a6e22e>str</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>str</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>/&#39;/g</span>, <span style=color:#e6db74>&#34;&#39;&#39;&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>fetchDisqusComments</span>(<span style=color:#a6e22e>firstURL</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>isDone</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>posts</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>curURL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>firstURL</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>page</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isDone</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Fetching page </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>curURL</span>);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>json</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Success fetching page </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>page</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>posts</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>hasNext</span>) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>curURL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>firstURL</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&amp;cursor=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>cursor</span>.<span style=color:#a6e22e>next</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>isDone</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>page</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>posts</span>);
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Converts Disqus comments array into an SQL transaction statement to insert into Commento&#39;s
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Postgres database.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>commentsToSQL</span>(<span style=color:#a6e22e>comments</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>sql</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>comments</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>accum</span>, <span style=color:#a6e22e>comment</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>escapeQuotes</span>(<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Add avatar to user if found (Commento calls this the &#34;photo&#34;).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasAvatar</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>avatar</span>.<span style=color:#a6e22e>large</span>.<span style=color:#a6e22e>permalink</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/images\/noavatar/</span>) <span style=color:#f92672>===</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>hasAvatar</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>accum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>accum</span>.<span style=color:#a6e22e>concat</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>UPDATE commenters
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SET photo=&#39;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>avatar</span>.<span style=color:#a6e22e>permalink</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WHERE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name=&#39;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    AND photo=&#39;undefined&#39;;`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Add link to author&#39;s website, or their Disqus profile url.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>link</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>profileUrl</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>accum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>accum</span>.<span style=color:#a6e22e>concat</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>UPDATE commenters
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SET link=&#39;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>link</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WHERE
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    name=&#39;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    AND link=&#39;undefined&#39;;`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Adds post points (Commento calls this the &#34;score&#34;).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>points</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>accum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>accum</span>.<span style=color:#a6e22e>concat</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>UPDATE comments
</span></span></span><span style=display:flex><span><span style=color:#e6db74>SET score=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>points</span><span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>WHERE 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    score=0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    AND html LIKE &#39;%</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>escapeQuotes</span>(<span style=color:#a6e22e>comment</span>.<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>50</span>))<span style=color:#e6db74>}</span><span style=color:#e6db74>%&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    AND exists (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        SELECT * 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        FROM commenters 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        WHERE commenters.commenterhex = comments.commenterhex
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        AND commenters.name = &#39;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    );
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>accum</span>;
</span></span><span style=display:flex><span>    }, <span style=color:#e6db74>&#39;BEGIN;&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sql</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sql</span><span style=color:#e6db74>}</span><span style=color:#e6db74>\nCOMMIT;`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sql</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>init</span>(<span style=color:#a6e22e>firstURL</span>, <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;/tmp/disqus-comments.sql&#39;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>comments</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetchDisqusComments</span>(<span style=color:#a6e22e>firstURL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sql</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>commentsToSQL</span>(<span style=color:#a6e22e>comments</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#a6e22e>filePath</span>, <span style=color:#a6e22e>sql</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Comments saved to </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>filePath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }); 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>init</span>(<span style=color:#e6db74>&#39;https://disqus.com/api/3.0/posts/list?attach=...&#39;</span>);
</span></span></code></pre></td></tr></table></div></div><p>Now all the SQL statements you need to run are at <code>/tmp/disqus-comments.sql</code>. If you are like me and are running Commento and its database in a Docker container, you can copy this into the container and run the SQL with the following:</p><ol><li>Find the id of the container running Postgres:<ul><li><code>docker ps</code></li></ul></li><li>Copy the file from your system into the Docker container:<ul><li><code>docker cp /tmp/disqus-comments.sql POSTGRES_CONTAINER_ID:/tmp/disqus-comments.sql</code></li></ul></li><li>Get inside the Postgres container:<ul><li><code>docker exec -it POSTGRES_CONTAINER_ID bash</code></li></ul></li><li>Run the SQL migration script:<ul><li><code>psql -U POSTGRES_USERNAME -d commento -f /tmp/disqus-comments.sql</code></li></ul></li></ol><p>Phew! That should be most of it. At this point you should now see user website links and comment points (score) showing up. But no avatars yet?! What gives?</p><p><a href=https://remysharp.com/2019/06/11/ejecting-disqus>Remy&rsquo;s</a> solution of self-hosting the original Disqus avatars is probably a better solution, but you can alternatively do what I did and simply point to the original Disqus image paths. But for that to work you need to make yet another tweak to <code>commento.js</code>! In two places I needed to change this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>avatar</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>create</span>(<span style=color:#e6db74>&#34;img&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>attrSet</span>(<span style=color:#a6e22e>avatar</span>, <span style=color:#e6db74>&#34;src&#34;</span>, <span style=color:#a6e22e>cdn</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/api/commenter/photo?commenterHex=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>commenter</span>.<span style=color:#a6e22e>commenterHex</span>);
</span></span></code></pre></td></tr></table></div></div><p>To this:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>isFullURL</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>commenter</span>.<span style=color:#a6e22e>photo</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/(http|https):\/\//</span>).<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>src</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>isFullURL</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>?</span> <span style=color:#a6e22e>commenter</span>.<span style=color:#a6e22e>photo</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>:</span> <span style=color:#a6e22e>cdn</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;/api/commenter/photo?commenterHex=&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>commenter</span>.<span style=color:#a6e22e>commenterHex</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>avatar</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>create</span>(<span style=color:#e6db74>&#34;img&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>attrSet</span>(<span style=color:#a6e22e>avatar</span>, <span style=color:#e6db74>&#34;src&#34;</span>, <span style=color:#a6e22e>src</span>);
</span></span></code></pre></td></tr></table></div></div><p>Which is a quick check to use the full URL if that&rsquo;s what&rsquo;s in the database (which is what the migrate script above did).</p><p>Phew, that was a lot! I left out a lot of steps about setting up a server on Amazon EC2, configuring the mail server, pointing the CNAME of <code>comments.davidbcalhoun.com</code> to the Amazon URL, setting up Docker containers, etc. You can read a bit of that in this <a href=https://www.freecodecamp.org/news/how-to-setup-worry-free-blog-comments-in-20-simple-steps/>article Jared Wolff wrote</a>.</p><p>At this point only a few pages on my site, including this one, are using the new self-hosted Commento comments. I want to make sure everything seems ready to go, and I&rsquo;m hoping to keep the EC2 instance within free limits, so hopefully after this setup it will be a truly free solution!</p><h2 id=related-links>Related links</h2><ul><li><a href=https://remysharp.com/2019/06/11/ejecting-disqus>Ejecting Disqus by Remy Sharp</a></li><li><a href=https://www.freecodecamp.org/news/how-to-setup-worry-free-blog-comments-in-20-simple-steps/>Brilliant Add-on For Static Sites That Will Make You Dance by Jared Wolff</a></li></ul></div></main><section class=comments><h2 class=page-header>Comments</h2><section id=commento></section><script src=/commento.js></script></section><footer role=contentinfo><p class="copyright text-muted">©<span itemscope itemtype=https://schema.org/Person><meta itemprop=name content="David Calhoun"><a href=https://www.themaingate.net/>David Calhoun</a></span> - <a href=https://www.davidbcalhoun.com/privacy/>Privacy</a> - <a href=https://www.davidbcalhoun.com/terms-of-service/>Terms</a></p></footer></body></html>